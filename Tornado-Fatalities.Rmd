---
title: "Tornado-Fatalities.Rmd"
author: "Tyler Fricker"
date: "9/20/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

Load packages.
```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(sf)
library(zoo)
```

Begin by reading in tornado-level estimates of socioeconomic and demographic variables.
```{r}
#unzip("SocialCorrelates.zip")
TornSC.sf <- st_read(dsn = "SocialCorrelates", 
                    layer = "SocialCorrelates", 
                    stringsAsFactors = FALSE) %>%
  mutate(date = as.Date(date),
         DateTim = as.POSIXct(paste(yr, mo, dy, time), format = "%Y%m%d%H:%M:%S"))
```

Look at killer tornadoes
```{r}
KillerTorn.sf <- TornSC.sf[TornSC.sf$fat > 0,]
```

Read in killer tornadoes csv and add fatality types and mobile home population. To calculate mobile home population, find the average number of people living in mobile homes (total pop (20 million) / mobile homes (8529795)). This value is 2.34.
```{r}
KillerTorn.df <- read.csv("KillerTornadoes.csv")

KillerTorn.sf$Pfat = KillerTorn.df$permanent_fat
KillerTorn.sf$MHfat = KillerTorn.df$mobile_fat
KillerTorn.sf$Ofat = KillerTorn.df$other_fat
KillerTorn.sf$Ufat = KillerTorn.df$unknown_fat

KillerTorn.sf$MHPop = KillerTorn.sf$MoblHms * 2.34
```

Evaluate the relationship between residential and non-residential fatalities in more detail
```{r}
df <- data.frame(KillerTorn.sf) %>%
  group_by(yr) %>%
  summarize(nT = n(),
         MHfat = sum(MHfat),
         NRfat = sum(Ofat),
         Pfat = sum(Pfat),
         Ufat = sum(Ufat),
         Rfat = sum(MHfat) + sum(Pfat)) %>%
  mutate(Ratio = NRfat/Rfat)

ggplot(df, aes(x = yr, y = Rfat)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()

ggplot(df, aes(x = yr, y = NRfat)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  xlab("Year") +
  ylab("Non-Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()

ggplot(df, aes(x = yr, y = Ratio)) +
  geom_point(color = "red") + 
  geom_smooth(method = lm, color = "red", size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Non-Residential Fatalities:Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()
```

Try to plot on same plane
```{r}
library(reshape2)
library(wesanderson)

dfM = melt(data = df, id.vars = "yr", measure.vars = c("Rfat", "NRfat"))

A = ggplot(dfM, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A <- A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("Rfat", "NRfat"),
                         labels=c("Residential", "Non-Residential"))

B <- ggplot(dfM, aes(x = yr, y = value, fill = variable)) +
  geom_bar(stat = "identity") +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()
  
B <- B + scale_fill_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         labels=c("Residential", "Non-Residential"))
```

Multiplot
```{r}
source("http://peterhaschke.com/Code/multiplot.R")

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))

B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))

multiplot(A, B, cols = 1)
```

Summarize fatality information
```{r}
summary(df)
```

Look at the seasonality of tornado fatality locations
```{r}
df2 <- data.frame(KillerTorn.sf) %>%
  group_by(mo) %>%
  summarize(nT = n(),
         MHfat = sum(MHfat),
         NRfat = sum(Ofat),
         Pfat = sum(Pfat),
         Ufat = sum(Ufat),
         Rfat = sum(MHfat) + sum(Pfat)) %>%
  mutate(Ratio = NRfat/Rfat,
         MonthF = factor(month.abb[mo], levels = month.abb),
         geometry = NULL)
```

Again, compare on the same plane.
```{r}
dfM2 = melt(data = df2, id.vars = "mo", measure.vars = c("Rfat", "NRfat"))

C = ggplot(dfM2, aes(x = mo, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = "lm", size = .35, se = FALSE) +
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("Month") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

C <- C + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("Rfat", "NRfat"),
                         labels=c("Residential", "Non-Residential"))

D <- ggplot(dfM2, aes(x = mo, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") + 
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("Month") +
  ylab("Number of Fatalities") +
  theme_minimal()
  
D <- D + scale_fill_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         labels=c("Residential", "Non-Residential"))

C = C + ggtitle("C") + 
  theme(plot.title=element_text(hjust=0))

D = D + ggtitle("D") + 
  theme(plot.title=element_text(hjust=0))
```

Plot yearly and monthly relationships together
```{r}
multiplot(A, B, C, D, cols = 2)
```


Next, compare the relationship between mobile homes and permanent homes.
```{r}
dfM <- melt(data = df, id.vars = "yr", measure.vars = c("MHfat", "Pfat"))

A <- ggplot(dfM, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("MHfat", "Pfat"),
                         labels=c("Mobile Home", "Residential\n[Non-Mobile Home]"))
```

Try without 2011
```{r}
df2 = data.frame(df) %>%
  filter(yr != 2011) %>%
  select(yr, MHfat, Pfat)

df2[nrow(df2) + 1,] = c(2011, 26, 19)

df2M = melt(data = df2, id.vars = "yr", measure.vars = c("MHfat", "Pfat"))

A = ggplot(df2M, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("MHfat", "Pfat"),
                         labels=c("Mobile Home", "Residential\n[Non-Mobile Home]"))
```

```{r}
df2 <- KillerTorn.sf %>%
  group_by(st) %>%
  summarize(MHfat = sum(MHfat),
            MH = sum(MoblHms),
            MHfatRate = sum(MHfat)/sum(MoblHms)) %>%
  filter(MHfat >= 10) %>%
  arrange(desc(MHfatRate))
```


