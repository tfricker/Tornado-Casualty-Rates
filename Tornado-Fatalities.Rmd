---
title: "Tornado-Fatalities.Rmd"
author: "Tyler Fricker"
date: "9/20/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

Load packages.
```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(sf)
```

Begin by reading in tornado-level estimates of socioeconomic and demographic variables.
```{r}
#unzip("SocialCorrelates.zip")
TornSC.sf <- st_read(dsn = "SocialCorrelates", 
                    layer = "SocialCorrelates", 
                    stringsAsFactors = FALSE) %>%
  mutate(date = as.Date(date),
         DateTim = as.POSIXct(paste(yr, mo, dy, time), format = "%Y%m%d%H:%M:%S"))
```

Look at killer tornadoes
```{r}
KillerTorn.sf <- TornSC.sf[TornSC.sf$fat > 0,]
```

Read in killer tornadoes csv and add fatality types and mobile home population. To calculate mobile home population, find the average number of people living in mobile homes (total pop (20 million) / mobile homes (8529795)). This value is 2.34.
```{r}
KillerTorn.df <- read.csv("KillerTornadoes.csv")

KillerTorn.sf$Pfat = KillerTorn.df$permanent_fat
KillerTorn.sf$MHfat = KillerTorn.df$mobile_fat
KillerTorn.sf$Ofat = KillerTorn.df$other_fat
KillerTorn.sf$Ufat = KillerTorn.df$unknown_fat

KillerTorn.sf$MHPop = KillerTorn.sf$MoblHms * 2.34
```

Look at mobile home fatalities in more detail
```{r}
sum(KillerTorn.sf$MHfat)/sum(KillerTorn.sf$fat)

df <- KillerTorn.sf %>%
  group_by(yr) %>%
  summarize(nT = n(),
         MHfat = sum(MHfat),
         NRfat = sum(Ofat),
         Pfat = sum(Pfat),
         Ufat = sum(Ufat),
         Rfat = sum(MHfat) + sum(Pfat))

ggplot(df, aes(x = yr, y = Rfat)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()

ggplot(df, aes(x = yr, y = NRfat)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  xlab("Year") +
  ylab("Non-Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()
```

Try to plot on same plane
```{r}
library(reshape2)
library(wesanderson)

dfM = melt(data = df, id.vars = "yr", measure.vars = c("Rfat", "NRfat"))

A = ggplot(dfM, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("Rfat", "NRfat"),
                         labels=c("Residential", "Non-Residential"))
```

Next, compare the relationship between mobile homes and permanent homes.
```{r}
dfM = melt(data = df, id.vars = "yr", measure.vars = c("MHfat", "Pfat"))

A = ggplot(dfM, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("MHfat", "Pfat"),
                         labels=c("Mobile Home", "Residential\n[Non-Mobile Home]"))
```

Try without 2011
```{r}
df2 = data.frame(df) %>%
  filter(yr != 2011) %>%
  select(yr, MHfat, Pfat)

df2[nrow(df2) + 1,] = c(2011, 26, 19)

df2M = melt(data = df2, id.vars = "yr", measure.vars = c("MHfat", "Pfat"))

A = ggplot(df2M, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("MHfat", "Pfat"),
                         labels=c("Mobile Home", "Residential\n[Non-Mobile Home]"))
```

```{r}
df2 <- KillerTorn.sf %>%
  group_by(st) %>%
  summarize(MHfat = sum(MHfat),
            MH = sum(MoblHms),
            MHfatRate = sum(MHfat)/sum(MoblHms)) %>%
  filter(MHfat >= 10) %>%
  arrange(desc(MHfatRate))
```


