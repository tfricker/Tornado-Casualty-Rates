---
title: "Tornado-Fatalities.Rmd"
author: "Tyler Fricker"
date: "9/20/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this paper is to provide information on tornado fatalities in a current context. Tornado-level information on the number of tornado fatalities is available from the NWS in the form of SVRGIS data. Additional information on the location of each fatality, if known, can be found through Storm Data.

Load packages.
```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(sf)
library(zoo)
library(rgeos)
library(rgdal)
library(scales)
library(tmap)
library(USAboundaries)
library(areal)
library(tidycensus)
library(ipumsr)
```

Begin by reading in tornado-level estimates of socioeconomic and demographic variables.
```{r}
#unzip("SocialCorrelates.zip")
TornSC.sf <- st_read(dsn = "SocialCorrelates", 
                    layer = "SocialCorrelates", 
                    stringsAsFactors = FALSE) %>%
  mutate(date = as.Date(date),
         DateTim = as.POSIXct(paste(yr, mo, dy, time), format = "%Y%m%d%H:%M:%S"))
```

Subset by only those tornadoes that have caused at least one fatality.
```{r}
KillerTorn.sf <- TornSC.sf[TornSC.sf$fat > 0,]
```

Read in killer tornadoes csv (now TornadoFatalities.csv) and add fatality types and mobile home population. To calculate mobile home population, find the average number of people living in mobile homes (total pop (20 million) / mobile homes (8684414)). This value is 2.3.

This mobile home information is found using 2010 (2008--2012) ACS 5-year estimate selected housing characteristics data (https://data.census.gov/cedsci/table?q=housing%20units&hidePreview=false&tid=ACSDP5Y2012.DP04&t=Housing%20Units&vintage=2018).
```{r}
KillerTorn.df <- read.csv("TornadoFatalities.csv")

# Fatality locations
KillerTorn.sf$Pfat = KillerTorn.df$permanent_fat
KillerTorn.sf$MHfat = KillerTorn.df$mobile_fat
KillerTorn.sf$Ofat = KillerTorn.df$other_fat
KillerTorn.sf$Ufat = KillerTorn.df$unknown_fat
KillerTorn.sf$Busfat = KillerTorn.df$business_fat
KillerTorn.sf$Chfat = KillerTorn.df$church_fat
KillerTorn.sf$Schfat = KillerTorn.df$school_fat
KillerTorn.sf$PermSfat = KillerTorn.df$permstructure_fat
KillerTorn.sf$Outfat = KillerTorn.df$outside_fat
KillerTorn.sf$Vehfat = KillerTorn.df$vehicle_fat

#Fatality information
KillerTorn.sf$Malefat = KillerTorn.df$male_fat
KillerTorn.sf$Femalefat = KillerTorn.df$female_fat
KillerTorn.sf$UGen = KillerTorn.df$unknown_gender
KillerTorn.sf$Un18fat = KillerTorn.df$fat_under18
KillerTorn.sf$fat_18t44 = KillerTorn.df$fat_18t44
KillerTorn.sf$fat_45t74 = KillerTorn.df$fat_45t64
KillerTorn.sf$Ovr65fat = KillerTorn.df$fat_over65
KillerTorn.sf$UAge = KillerTorn.df$unknown_age


KillerTorn.sf$MHPop = KillerTorn.sf$MoblHms * 2.3
```

## Preliminary Analysis

Investigate fatalities in more detail. Begin with annual information.
```{r}
df <- data.frame(KillerTorn.sf) %>%
  group_by(yr) %>%
  summarize(nT = n(),
            nF = sum(fat))

summary(df$nF)
```

On average, over the past 24 years, 74 people have been killed in tornadoes per year. The median number of annual fatalities is 46 with an inter-quartile range between 35 and 68.

Create plots showing the number of fatalities by year and the numbr of killer tornadoes by year.
```{r}
A <- ggplot(df, aes(x = yr, y = nF)) +
  geom_line() +
  geom_smooth() +
  xlab("Year") +
  ylab("Number of Fatalities") +
  scale_y_continuous(breaks = c(-200, 0, 200, 400), labels = c("",0, 200, 400)) +
  theme_minimal()

B <- ggplot(df, aes(x = yr, y = nT)) +
  geom_line() +
  geom_smooth() +
  xlab("Year") +
  ylab("Number of Killer Tornadoes") +
  theme_minimal()
```

Then move on to a plot on the number of fatalities per month.
```{r}
df2 <- data.frame(KillerTorn.sf) %>%
  group_by(mo) %>%
  summarize(nT = n(),
            nF = sum(fat)) %>%
  mutate(MonthF = factor(month.abb[mo], levels = month.abb))

C <- ggplot(df2, aes(x = mo, y = nF)) +
  geom_bar(stat = "identity") + 
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("") +
  ylab("Number of Fatalities") +
  theme_minimal()
```

Finally find the cumulative distribution and plot it on a log-log scale.
```{r}
df3 <- data.frame(table(KillerTorn.sf$fat))

D = ggplot(df3, aes(x = as.integer(Var1), y = Freq)) +
  scale_x_log10() + scale_y_log10() +
  geom_point() + 
  xlab(expression(paste("Number of Fatalities"))) +
  ylab("Number of Tornadoes") +
  theme_minimal()
```

Multiplot
```{r}
source("http://peterhaschke.com/Code/multiplot.R")

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))

B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))

C = C + ggtitle("C") + 
  theme(plot.title=element_text(hjust=0))

D = D + ggtitle("D") + 
  theme(plot.title=element_text(hjust=0))

multiplot(A, C, B, D, cols = 2)
```

Over the past 24 years, the number of fatalties per has been rather constant with a slight decrease over the past 5+ years. The number of killer tornadoes has also been rather constant with a slight decreease over the past 5+ years.

The number of tornado fatalities is greatest in the months of April and May and lowest during the summer (July and August).

Model this rate
```{r}
model1 = lm(fat ~ Year, data = TornSC.sf[TornSC.sf$Year >= 1995,])
summary(model1)

model2 = lm(fat ~ Year, data = TornSC.sf[TornSC.sf$Year >= 2007,])
summary(model2)
```

Idealized Dasymetric Procedure Model
```{r}
EF0m = matrix(c(0, 0, 200, 200, 0, 0, 50, 50, 0, 0), 
              nrow = 5, ncol = 2)
EF1m = matrix(c(52.9, 52.9, 147.1, 147.1, 52.9, 13.225, 36.775, 36.775, 13.225, 13.225),
              nrow = 5, ncol = 2)
EF2m = matrix(c(80, 80, 120, 120, 80, 20, 30, 30, 20, 20), 
              nrow = 5, ncol = 2)
EF3m = matrix(c(93.3, 93.3, 106.7, 106.7, 93.3, 23.325, 26.675, 26.675, 23.325, 23.325), 
              nrow = 5, ncol = 2)
trackm = matrix(c(-20, 25, 220, 25), nrow = 2, ncol = 2, byrow = TRUE)

theta = -pi/6
rot = matrix(c(cos(theta), -sin(theta), sin(theta), cos(theta)),
             nrow = 2, ncol = 2, byrow = TRUE)
EF0r = EF0m %*% rot
EF1r = EF1m %*% rot
EF2r = EF2m %*% rot
EF3r = EF3m %*% rot
trackr = trackm %*% rot

EF0 = Polygons(list(Polygon(EF0r)), 0)
EF1 = Polygons(list(Polygon(EF1r)), 1)
EF2 = Polygons(list(Polygon(EF2r)), 2)
EF3 = Polygons(list(Polygon(EF3r)), 3)
spsNRC3 = SpatialPolygons(list(EF0, EF1, EF2, EF3))

spsNRC3A.df = fortify(spsNRC3)
spsNRC3A.df$EF = paste("EF", spsNRC3A.df$id, sep = "")

box1 = data.frame(long = c(-50, -50, 0, 0, -50),
                 lat = c(0, 50, 50, 0, 0))
box2 = data.frame(long = c(0, 0, 50, 50, 0),
                 lat = c(0, 50, 50, 0, 0))
box3 = data.frame(long = c(50, 50, 100, 100, 50),
                 lat = c(0, 50, 50, 0, 0))
box4 = data.frame(long = c(100, 100, 150, 150, 100),
                 lat = c(0, 50, 50, 0, 0))
box5 = data.frame(long = c(150, 150, 200, 200, 150),
                 lat = c(0, 50, 50, 0, 0))
box6 = data.frame(long = c(-50, -50, 0, 0, -50),
                 lat = c(50, 100, 100, 50, 50))
box7 = data.frame(long = c(0, 0, 50, 50, 0),
                 lat = c(50, 100, 100, 50, 50))
box8 = data.frame(long = c(50, 50, 100, 100, 50),
                 lat = c(50, 100, 100, 50, 50))
box9 = data.frame(long = c(100, 100, 150, 150, 100),
                 lat = c(50, 100, 100, 50, 50))
box10 = data.frame(long = c(150, 150, 200, 200, 150),
                 lat = c(50, 100, 100, 50, 50))
box11 = data.frame(long = c(-50, -50, 0, 0, -50),
                 lat = c(100, 150, 150, 100, 100))
box12 = data.frame(long = c(0, 0, 50, 50, 0),
                 lat = c(100, 150, 150, 100, 100))
box13 = data.frame(long = c(50, 50, 100, 100, 50),
                 lat = c(100, 150, 150, 100, 100))
box14 = data.frame(long = c(100, 100, 150, 150, 100),
                 lat = c(100, 150, 150, 100, 100))
box15 = data.frame(long = c(150, 150, 200, 200, 150),
                 lat = c(100, 150, 150, 100, 100))

box.df = rbind(box1, box2, box3, box4, box5, box6, box7, box8, box9, box10, box11, box12, box13, box14, box15)
box.df$inc = rep(c("< 10", "10 - 20", "31 - 40", "10 - 20", "< 10", "< 10", "21 - 30", "> 40", "21 - 30", "< 10", "< 10", "10 - 20", "31 - 40", "10 - 20", "< 10"), each = 5)
box.df$id = rep(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15), each = 5)

lims = c("< 10", "10 - 20", "21 - 30", "31 - 40", "> 40")
brks = c("< 10", "10 - 20", "21 - 30", "31 - 40", "> 40") 
vals = c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c") 

ggplot(spsNRC3A.df[spsNRC3A.df$EF == "EF0", ], aes(x = long, y = lat)) +
  scale_x_continuous(limits = c(-50, 200)) +
  scale_y_continuous(limits = c(0, 150)) +
  coord_fixed() +
  geom_polygon(mapping = aes(long, lat, fill = factor(inc), group = id), data = box.df) +
  geom_polygon(mapping = aes(long, lat, fill = factor(inc), group = id), data = box.df, color = "white", show_guide=FALSE) +
  geom_polygon(fill = "transparent", color = "black") +
  scale_fill_manual(name = expression("Population"), limits = lims, breaks = brks, values = vals) +
  geom_segment(x = trackr[1, 1], 
               xend = trackr[2, 1], 
               y = trackr[1, 2], 
               yend = trackr[2, 2], 
               arrow = grid::arrow(length = grid::unit(.6, "cm"), type = "closed"), 
               size = 1.0, 
               color = "black") +
  xlab("") + ylab("") +
   theme(panel.background = element_blank(),
        panel.grid.major = element_line(colour = "gray", 
                                        size = .25, 
                                        linetype = 'dashed'),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        strip.background = element_blank()) 
```

### Tornado fatality rates by year, month, and hour ###

Per-captia and per-housing unit fatality rates
```{r}
(sum(KillerTorn.df$fat)/sum(KillerTorn.df$TotalPp)) * 100
(sum(KillerTorn.df$fat)/sum(KillerTorn.df$TtlHsnU)) * 100
```

Annual fatality rates
```{r}
df <- data.frame(KillerTorn.sf) %>%
  group_by(Year) %>%
  summarize(PCfatRate = sum(fat)/sum(TotalPp),
            PHUfatRate = sum(fat)/sum(TtlHsnU),
            pop = sum(TotalPp),
            HU = sum(TtlHsnU),
            nT = n())
```

Monthly fatality rates
```{r}
df <- data.frame(KillerTorn.sf) %>%
  group_by(mo) %>%
  summarize(PCfatRate = sum(fat)/sum(TotalPp),
            PHUfatRate = sum(fat)/sum(TtlHsnU),
            pop = sum(TotalPp),
            HU = sum(TtlHsnU),
            nT = n()) %>%
  mutate(MonthF = factor(month.abb[mo], levels = month.abb))
```

Plot the monthly rates
```{r}
A = ggplot(df, aes(x = mo, y = PCfatRate)) +
  geom_bar(stat = "identity") +
  coord_polar() +
  scale_x_continuous(breaks = seq(1,12), labels = df$MonthF, minor_breaks = NULL) +
  xlab("") +
  scale_y_continuous(labels = label_percent(accuracy = .01, scale = 100)) +
  ylab("Per-Capita Fatality Rate") +
  theme_minimal() +
  theme(axis.ticks.y = element_line(),
        panel.border = element_rect(fill = NA))

B = ggplot(df, aes(x = mo, y = PHUfatRate)) +
  geom_bar(stat = "identity") +
  coord_polar() +
  scale_x_continuous(breaks = seq(1,12), labels = df$MonthF, minor_breaks = NULL) +
  xlab("") +
  scale_y_continuous(labels = label_percent(accuracy = .01, scale = 100)) +
  ylab("Per-Housing Unit Fatality Rate") +
  theme_minimal() +
  theme(axis.ticks.y = element_line(),
        panel.border = element_rect(fill = NA))

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))

B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))

multiplot(A, B, cols = 2)
```

Hourly Rates
```{r}
df <- data.frame(KillerTorn.sf) %>%
  group_by(Hour) %>%
  summarize(PCfatRate = sum(fat)/sum(TotalPp),
            PHUfatRate = sum(fat)/sum(TtlHsnU),
            pop = sum(TotalPp),
            HU = sum(TtlHsnU),
            nT = n())

C = ggplot(df, aes(x = Hour, y = PCfatRate)) +
  geom_bar(stat = "identity") +
  coord_polar() +
  scale_x_continuous(breaks = c(0, 3, 6, 9, 12, 15, 18, 21), labels = c("12:00 AM", "3:00 AM", "6:00 AM", "9:00 AM", "12:00 PM", "3:00 PM", "6:00 PM", "9:00 PM")) +
  xlab("") +
  scale_y_continuous(labels = label_percent(accuracy = .01, scale = 100)) +
  ylab("Per-Capita Fatality Rate") +
  theme_minimal() +
  theme(axis.ticks.y = element_line(),
        panel.border = element_rect(fill = NA))

D = ggplot(df, aes(x = Hour, y = PHUfatRate)) +
  geom_bar(stat = "identity") +
  coord_polar() +
  scale_x_continuous(breaks = c(0, 3, 6, 9, 12, 15, 18, 21), labels = c("12:00 AM", "3:00 AM", "6:00 AM", "9:00 AM", "12:00 PM", "3:00 PM", "6:00 PM", "9:00 PM")) +
  xlab("") +
  scale_y_continuous(labels = label_percent(accuracy = .01, scale = 100)) +
  ylab("Per-Housing Unit Fatality Rate") +
  theme_minimal() +
  theme(axis.ticks.y = element_line(),
        panel.border = element_rect(fill = NA))

C = C + ggtitle("C") + 
  theme(plot.title=element_text(hjust=0))

D = D + ggtitle("D") + 
  theme(plot.title=element_text(hjust=0))

multiplot(A, C, B, D, cols = 2)
```

### Tornado fatality rates by location ###

```{r}
df = data.frame(KillerTorn.sf) %>%
  mutate(other = Busfat + Chfat + Schfat + PermSfat + Outfat + Vehfat) %>%
  select(Ofat, other)

x = data.frame(df$Ofat == df$other)
```

Break down tornado fatalities by location
```{r}
library(reshape2)
df <-  data.frame(KillerTorn.sf)%>%
  select(Pfat, MHfat, Ofat, Ufat, Busfat, Chfat, Schfat, 
         PermSfat, Outfat, Vehfat)

# Reorder columns
df <- df[c(1,2,5,6,7,8,9,10,3,4)]

df2 <- melt(df) %>%
  group_by(variable) %>%
  summarize(nF = sum(value)) %>%
  rename(Location = variable)

df2$nF[9] = 2 # Correct for the two fatalities that were labeled "other" in Storm Events
```

Make a barplot of the number of fatalities by location over the study period.
```{r}
A <- ggplot(df2, aes(x = Location, y = nF)) +
  geom_bar(stat = 'identity', aes(fill = Location)) +
  scale_x_discrete(labels = c('Permanent\nHome', 'Mobile\nHome', 'Business', 'Church', 'School', 'Permanent\nStructure', 'Outside', 'Vehicle', 'Other', 'Unknown')) +
  xlab("") +
  ylab("Number of Fatalities") +
  scale_fill_brewer(palette = 'Paired', 10) +
  theme_minimal() +
  theme(legend.position = "none")

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))
```

Evaluate trends in fatality location over time.
```{r}
library(tidyr)
df <-  data.frame(KillerTorn.sf)%>%
  select(om, date, st, Year, Pfat, MHfat, Ofat, Ufat, Busfat, Chfat, Schfat, 
         PermSfat, Outfat, Vehfat, Ufat) %>%
  mutate(Ofat = Ofat - (Busfat + Chfat + Schfat + PermSfat + Outfat + Vehfat)) %>%
  group_by(Year) %>%
  summarize(Pfat = sum(Pfat), MHfat = sum(MHfat), Ofat = sum(Ofat), Ufat = sum(Ufat), Busfat = sum(Busfat), Chfat = sum(Chfat), Schfat = sum(Schfat), PermSfat = sum(PermSfat), Outfat = sum(Outfat), Vehfat = sum(Vehfat))

# Reorder columns
df <- df[c(1,2,3,6,7,8,9,10,11,4,5)]

df2 <- df %>%
  gather(key = Year, value = Value) %>%
  rename(Location = Year) %>%
  mutate(Year = rep(1995:2018, 10))
```

Plot it
```{r}
# Ensure the levels are aligned with the previous plot
df2$Location <- factor(df2$Location, levels = unique(df2$Location))

B <- ggplot(df2, aes(x = Year, y = Value)) +
  geom_line(aes(color = Location), size = 1) +
  scale_color_brewer(labels = c('Permanent\nHome', 'Mobile\nHome', 'Business', 'Church', 'School', 'Permanent\nStructure', 'Outside', 'Vehicle', 'Other', 'Unknown'), palette = 'Paired', direction = 1) +
  ylab("Number of Fatalities") +
  theme_minimal()


B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))

multiplot(A, B, cols = 1)
```

What do residential and non-residential fatality rates look like?
```{r}
(sum(KillerTorn.sf$MHfat) + sum(KillerTorn.sf$Pfat))/sum(KillerTorn.sf$TotalPp)
sum(KillerTorn.sf$Ofat)/sum(KillerTorn.sf$TotalPp)
```

What do vehicle fatality rates look like? To find this, think about vehicles per capita (.831 - found by dividing vehicle registrations by population) (https://www.fhwa.dot.gov/policyinformation/statistics/2018/pdf/mv1.pdf) and per household (1.9).'
```{r}
KillerTorn.sf$VehiclePop = KillerTorn.sf$TotalPp * .831
KillerTorn.sf$VehiclePop2 = KillerTorn.sf$TtlHsnU * 1.9

sum(KillerTorn.sf$Vehfat)/sum(KillerTorn.sf$VehiclePop)
sum(KillerTorn.sf$Vehfat)/sum(KillerTorn.sf$VehiclePop2)
```

Evaluate the relationship between residential and non-residential fatalities in more detail
```{r}
df <- data.frame(KillerTorn.sf) %>%
  group_by(yr) %>%
  summarize(nT = n(),
         MHfat = sum(MHfat),
         NRfat = sum(Ofat),
         Pfat = sum(Pfat),
         Ufat = sum(Ufat),
         Rfat = sum(MHfat) + sum(Pfat)) %>%
  mutate(Ratio = NRfat/Rfat)

ggplot(df, aes(x = yr, y = Rfat)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()

ggplot(df, aes(x = yr, y = NRfat)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  xlab("Year") +
  ylab("Non-Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()

ggplot(df, aes(x = yr, y = Ratio)) +
  geom_bar(stat = "identity") + 
  geom_smooth(method = lm, size = .35, se = TRUE) +
  xlab("Year") +
  ylab("Non-Residential Fatalities:Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()

ggplot(df, aes(x = yr, y = Ratio)) +
  geom_point() + 
  geom_smooth(method = lm, se = TRUE) +
  xlab("Year") +
  ylab("Non-Residential Fatalities:Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()
```

Try to plot on same plane
```{r}
library(reshape2)
library(wesanderson)

dfM = melt(data = df, id.vars = "yr", measure.vars = c("Rfat", "NRfat"))

A = ggplot(dfM, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A <- A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("Rfat", "NRfat"),
                         labels=c("Residential", "Non-Residential"))

B <- ggplot(dfM, aes(x = yr, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()
  
B <- B + scale_fill_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         labels=c("Residential", "Non-Residential"))

multiplot(A, B, cols = 2)

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))
```

Summarize fatality information
```{r}
summary(df)
```

Look at the seasonality of tornado fatality locations
```{r}
df2 <- data.frame(KillerTorn.sf) %>%
  group_by(mo) %>%
  summarize(nT = n(),
         MHfat = sum(MHfat),
         NRfat = sum(Ofat),
         Pfat = sum(Pfat),
         Ufat = sum(Ufat),
         Rfat = sum(MHfat) + sum(Pfat)) %>%
  mutate(Ratio = NRfat/Rfat,
         MonthF = factor(month.abb[mo], levels = month.abb),
         Rci = qt(0.9, df = nT - 1) * sd(Rfat)/sqrt(nT),
         NRci = qt(0.9, df = nT - 1) * sd(NRfat)/sqrt(nT),
         geometry = NULL) 
```

Look at the ratio by month
```{r}
ggplot(df2, aes(x = mo, y = Ratio)) +
  geom_bar(stat = "identity") + 
  #geom_smooth(method = loess, color = "red", size = .35, se = TRUE) +
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("Year") +
  ylab("Non-Residential Fatalities:Residential Fatalities") +
#  coord_cartesian(ylim = c(0, 300)) +
  theme_minimal()
```

Again, compare on the same plane.
```{r}
dfM2 <- melt(data = df2, id.vars = c("mo", "Rci", "NRci"), measure.vars = c("Rfat", "NRfat"))

#dfM2 = melt(data = df2, id.vars = c("mo", "nT"), measure.vars = c("Rfat", "NRfat")) %>%
#  mutate(ci = qt(0.975, df = nT -1) * sd(value)/sqrt(nT))

errors = aggregate(.~ mo + variable, 
                   data = dfM2, 
                   FUN = sd)

C = ggplot(dfM2, aes(x = mo, y = value, colour = variable)) +
  geom_point(position = position_dodge(0.5)) +
  #geom_smooth(method = "lm", size = .35, se = FALSE) +
  geom_errorbar(data = dfM2[dfM2$variable == "Rfat",], aes(ymin = ifelse(value-Rci < 0, 0, value-Rci), ymax = value + Rci), 
                width = .25, 
                position = position_dodge(-1.5)) +
  geom_errorbar(data = dfM2[dfM2$variable == "NRfat",], aes(ymin = ifelse(value-NRci < 0, 0, value-NRci), ymax = value + NRci), 
                width = .25, 
                position = position_dodge(0.5)) +
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("Month") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

C <- C + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("Rfat", "NRfat"),
                         labels=c("Residential", "Non-Residential"))

D <- ggplot(dfM2, aes(x = mo, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") + 
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("Month") +
  ylab("Number of Fatalities") +
  theme_minimal()
  
D <- D + scale_fill_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         labels=c("Residential", "Non-Residential"))

C = C + ggtitle("C") + 
  theme(plot.title=element_text(hjust=0))

D = D + ggtitle("D") + 
  theme(plot.title=element_text(hjust=0))
```

Plot yearly and monthly relationships together
```{r}
multiplot(A, B, C, D, cols = 2)

#multiplot(A, D, cols = 1)
```

Next, compare the relationship between mobile homes and permanent homes.

Look at fatality rates
```{r}
sum(KillerTorn.sf$MHfat)/sum(KillerTorn.sf$MHPop)
sum(KillerTorn.sf$MHfat)/sum(KillerTorn.sf$MoblHms)
sum(KillerTorn.sf$Pfat)/(sum(KillerTorn.sf$TotalPp) - sum(KillerTorn.sf$MHPop))
sum(KillerTorn.sf$Pfat)/(sum(KillerTorn.sf$TtlHsnU)-sum(KillerTorn.sf$MoblHms))
```

```{r}
dfM <- melt(data = df, id.vars = "yr", measure.vars = c("Pfat","MHfat"))
dfM2 <- melt(data = df2, id.vars = "mo", measure.vars = c("Pfat", "MHfat"))

A <- ggplot(dfM, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

B <- ggplot(dfM2, aes(x = mo, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") + 
  scale_x_continuous(breaks = seq(1,12), labels = df2$MonthF, minor_breaks = NULL) +
  xlab("Month") +
  ylab("Number of Fatalities") +
  theme_minimal()

#pal = wes_palette("Moonrise1")
#pal2 = wes_palette("Moonrise2")

A <- A + scale_color_manual(values=c("#A6CEE3", "#1F78B4"),
                         name="Fatality Location",
                         breaks=c("Pfat", "MHfat"),
                         labels=c("Permanent Home", "Mobile Home"))

B <- B + scale_fill_manual(values=c("#A6CEE3", "#1F78B4"),
                         name="Fatality Location",
                         labels=c("Permanent Home", "Mobile Home"))

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))

B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))
```

Plot yearly and monthly relationships together
```{r}
multiplot(A, B, cols = 1)
```

Try without 2011
```{r}
df2 = data.frame(df) %>%
  filter(yr != 2011) %>%
  select(yr, MHfat, Pfat)

df2[nrow(df2) + 1,] = c(2011, 26, 19)

df2M = melt(data = df2, id.vars = "yr", measure.vars = c("MHfat", "Pfat"))

A = ggplot(df2M, aes(x = yr, y = value, colour = variable)) +
  geom_point() + geom_smooth(method = lm, size = .35, se = FALSE) +
  xlab("Year") +
  ylab("Number of Fatalities") +
  theme_minimal()

pal = wes_palette("GrandBudapest1")
pal2 = wes_palette("GrandBudapest2")

A + scale_color_manual(values=c( "#7294D4", "#5B1A18"),
                         name="Fatality Location",
                         breaks=c("MHfat", "Pfat"),
                         labels=c("Mobile Home", "Permanent Home"))
```

```{r}
df2 <- KillerTorn.sf %>%
  group_by(st) %>%
  summarize(MHfat = sum(MHfat),
            MH = sum(MoblHms),
            MHfatRate = sum(MHfat)/sum(MoblHms)) %>%
  filter(MHfat >= 10) %>%
  arrange(desc(MHfatRate))
```

Look at fatality information

### Tornado fatality rates by Age and Sex ###

Find the number of tornado fatalities by age group and the total population by age group
```{r}
df = data.frame(KillerTorn.sf) %>%
  summarise(Under18Fat = sum(Un18fat),
         Fat18t44 = sum(fat_18t44),
         Fat45t64 = sum(fat_45t74),
         Over65Fat = sum(Ovr65fat),
         Under18Pop = sum(MlUnd18 + FmlUn18),
         Pop18t44 = sum(Ml18t44 + Fml1844),
         Pop45t64 = sum(Ml45t64 + Fml4564),
         Over65Pop = sum(MlOvr65 + FmlOv65))
```

Per-capita fatality rates by age
```{r}
df$Under18Fat/df$Under18Pop * 100
df$Fat18t44/df$Pop18t44 * 100
df$Fat45t64/df$Pop45t64 * 100
df$Over65Fat/df$Over65Pop * 100
```

Per-housing unit fatality rates by age
```{r}
(df$Under18Fat/sum(KillerTorn.sf$TtlHsnU)) * 100
(df$Fat18t44/sum(KillerTorn.sf$TtlHsnU)) * 100
(df$Fat45t64/sum(KillerTorn.sf$TtlHsnU)) * 100
(df$Over65Fat/sum(KillerTorn.sf$TtlHsnU)) * 100
```


```{r}
df <- df %>%
  reshape2::melt(.)

A = ggplot(df[1:4,], aes(x = variable, y = value)) + 
  geom_bar(stat = "identity") +
  scale_x_discrete(breaks = c("Under18Fat", "Fat18t44", "Fat45t64", "Over65Fat"), 
                   labels = c("Under 18", "18 to 44", "45 to 64", "Over 65")) +
  ylab("Number of Fatalities") +
  xlab("") +
  theme_minimal()

C = ggplot(df[5:8,], aes(x = variable, y = value)) + 
  geom_bar(stat = "identity") +
  scale_x_discrete(breaks = c("Under18Pop", "Pop18t44", "Pop45t64", "Over65Pop"), 
                   labels = c("Under 18", "18 to 44", "45 to 64", "Over 65")) +
  ylab("Number of People") +
  xlab("") +
  theme_minimal()

A = A + ggtitle("A") + 
  theme(plot.title=element_text(hjust=0))

C = C + ggtitle("C") + 
  theme(plot.title=element_text(hjust=0))
```

Age by Percentage
```{r}
df = data.frame(KillerTorn.sf) %>%
  summarise(Under18Fat = sum(Un18fat)/sum(fat),
         Fat18t44 = sum(fat_18t44)/sum(fat),
         Fat45t64 = sum(fat_45t74)/sum(fat),
         Over65Fat = sum(Ovr65fat)/sum(fat),
         Under18Pop = sum(MlUnd18 + FmlUn18)/sum(TotalPp),
         Pop18t44 = sum(Ml18t44 + Fml1844)/sum(TotalPp),
         Pop45t64 = sum(Ml45t64 + Fml4564)/sum(TotalPp),
         Over65Pop = sum(MlOvr65 + FmlOv65)/sum(TotalPp)) %>%
  reshape2::melt(.)

B = ggplot(df[1:4,], aes(x = variable, y = value)) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  scale_x_discrete(breaks = c("Under18Fat", "Fat18t44", "Fat45t64", "Over65Fat"), 
                   labels = c("Under 18", "18 to 44", "45 to 64", "Over 65")) +
  ylab("Proportion of Fatalities") +
  xlab("") +
  theme_minimal()

D = ggplot(df[5:8,], aes(x = variable, y = value)) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
  scale_x_discrete(breaks = c("Under18Pop", "Pop18t44", "Pop45t64", "Over65Pop"), 
                   labels = c("Under 18", "18 to 44", "45 to 64", "Over 65")) +
  ylab("Proportion of People") +
  xlab("") +
  theme_minimal()

B = B + ggtitle("B") + 
  theme(plot.title=element_text(hjust=0))

D = D + ggtitle("D") + 
  theme(plot.title=element_text(hjust=0))

multiplot(A, C, B, D, cols = 2)
```

Find the number of tornado fatalities by sex and the total population by sex
```{r}
df = data.frame(KillerTorn.sf) %>%
  summarise(MaleFat = sum(Malefat),
            FemaleFat = sum(Femalefat),
            MalePop = sum(TotalMl),
            FemalePop = sum(TotlFml))
```

Find per-capita fatality rates.
```{r}
df$MaleFat/df$MalePop * 100
df$FemaleFat/df$FemalePop * 100
(df$MaleFat/sum(KillerTorn.sf$TtlHsnU)) * 100
(df$FemaleFat/sum(KillerTorn.sf$TtlHsnU)) * 100
```

### Tornado fatality rates by Age and Sex ###

Get state- and county-level data. Use the USAboundaires package to get a shapefile containing all counties in the US.
```{r}
states <- us_states()%>%
  st_transform(crs = 2163) %>%
  rename(st = state_abbr)

states <- states %>%
  filter(!st %in% c("AK", "PR", "HI"))

counties <- us_counties() %>%
  st_transform(crs = 2163) %>%
  rename(GEOID = geoid)

counties <- counties %>%
  filter(!state_abbr %in% c("AK", "PR", "HI"))

counties$GEOID = as.numeric(counties$GEOID)
counties$CountyArea = st_area(counties)
```

Find the number of tornadoes intersecting each county
```{r}
KillerTorn.sf <- st_transform(KillerTorn.sf, crs = 2163)
KillerTorn.sf$ID <- 1:nrow(KillerTorn.sf)

ct = st_intersection(counties, KillerTorn.sf)

x <- data.frame(ct) %>%
  group_by(GEOID, name, state_abbr) %>%
  summarize(nT = n())

CountyRates <- merge(counties, x, by = c("GEOID", "name", "state_abbr"))
```

Determine the proportion of the tornado path by area that falls inside each county. The rows index the tornado number and the columns index the county number. Call these tornado segments.

```{r}
Areas = aw_intersect(counties, KillerTorn.sf, areaVar = "TornAreaInCounty")
```

Casualties in the SPC are given per tornado but where they occurred within the path (or surrounding) is unknown. The likelihood of a casualty increases with the number of people in the path so we assign to each county under the tornado path a fraction of the number of casualties based on the number of people in the area.

Get county-level population. Use the population estimates from the Census Bureau from 1970-2014 see http://www.nber.org/data/census-intercensal-county-population.html. Use the 2014 value for 2015, 2016, 2017, and 2018. Census U.S. Intercensal County Population Data, 1970-2014 from http://www.nber.org/data/census-intercensal-county-population.html.

```{r}
pop = read.csv("county_pop_full_NEW.csv")

pop$pop2015 = pop$pop2014
pop$pop2016 = pop$pop2014
pop$pop2017 = pop$pop2014
pop$pop2018 = pop$pop2014
pop$pop19904 = NULL

pop2 = reshape2::melt(pop, id.vars = "county_name", measure.vars = 11:79)

colnames(pop2)[3] = "Population" 
pop2$Year = as.numeric(substring(pop2$variable, 4))
pop2$GEOID = pop$fips
```

```{r}
tmp = left_join(Areas, pop2[, c("Year", "GEOID", "Population")])
tmp$id = 1:nrow(tmp)
tmp = tmp[order(tmp$id), ]
```

```{r}
Areas = Areas %>%
  mutate(CountyPopulation = tmp$Population)
```

Compute the number of people exposed per tornado per county.
```{r}
Areas = Areas %>%
  mutate(CountyPopulationDensity = as.vector(CountyPopulation/CountyArea) * 10^6,
         PerTornPerCountyPeopleExposed = as.vector(CountyPopulationDensity * TornAreaInCounty))
```

Group by tornado and total the number of people exposed per tornado.
```{r}
perTorn = Areas %>%
  group_by(ID) %>%
  dplyr::summarize(PerTornPeopleExposed = sum(PerTornPerCountyPeopleExposed))

perTorn = perTorn[,c(1:2)]; perTorn$geometry = NULL
```

```{r}
Areas <- right_join(Areas, perTorn, by = "ID")

Areas = Areas %>%
  mutate(Ratio = PerTornPerCountyPeopleExposed/PerTornPeopleExposed)
```

```{r}
Areas = Areas %>%
  mutate(PerTornPerCountyFat = fat * Ratio,
         PerTornPerCountyPermFat = Pfat * Ratio,
         PerTornPerCountyMHFat = MHfat * Ratio)
```

Group by county and total the per tornado per county casualties.
```{r}
df = data.frame(Areas) %>%
  group_by(GEOID) %>%
  dplyr::summarize(Fat = sum(PerTornPerCountyFat),
                   PFat = sum(PerTornPerCountyPermFat),
                   MHFat = sum(PerTornPerCountyMHFat),
                   Population = sum(CountyPopulation),
                   PopulationDensity = mean(CountyPopulationDensity))

df <- merge(counties, df, by = c("GEOID"))

df$Fat = round(df$Fat)
df$PFat = round(df$PFat)
df$MHFat = round(df$MHFat)

df$logFat = log10(df$Fat)
df$logPFat = log10(df$PFat)
df$logMHFat = log10(df$MHFat)
```

All Fatalities 
```{r}
tm_shape(states, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(counties) +
  tm_borders(alpha = 0.2) + 
  tm_shape(df) + 
  tm_fill("logFat",
          breaks = c(0, .5, 1, 1.5, 2, 2.5),
          labels = c("1 to 16", "16 to 27", "27 to 45", "45 to 73", "> 73"),
          palette = "Reds", title = "Number of Fatalities") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE)
```

Mobile Home fatalities
```{r}
tm_shape(states, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(counties) +
  tm_borders(alpha = 0.2) + 
  tm_shape(df) + 
  tm_fill("logMHFat",
          breaks = c(0, .25, .5, .75, 1, 1.25),
          labels = c("1 to 12", "12 to 22", "22 to 27", "27 to 34", "> 34"),
          palette = "Reds", title = "Number of Fatalities") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE)
```

Create a map of rasters.
```{r}
library(raster)
xmn = -124.6813; xmx = -67.00742; ymn = 24.85; ymx = 49.38323; res = 0.6
r = raster(xmn = xmn, xmx = xmx,
           ymn = ymn, ymx = ymx,
           resolution = res)
ncell(r); nrow(r); ncol(r)

Rsp = as(r, "SpatialPolygonsDataFrame")
sfR = st_as_sf(Rsp)
sfT = st_transform(sfR, crs = "+init=epsg:2163")
```

Rasterize the population data. Use the Areas dataset, as it is the most fine-scale data for population in county.
```{r}
Areas$ID = 1:nrow(Areas)
sfT$ID2 = 1:nrow(sfT)

out = aw_interpolate(sfT, 
               tid = "ID2", 
               source = Areas, 
               sid = "ID",
               extensive = c("PerTornPerCountyMHFat", "PerTornPerCountyPermFat",
                             "PerTornPerCountyFat"),
               weight = "sum", 
               output = "sf")

out$MHFat <- round(out$PerTornPerCountyMHFat)
out$PFat <- round(out$PerTornPerCountyPermFat)
out$Fat <- round(out$PerTornPerCountyFat)

out$logMHFat = log10(out$MHFat)
out$logPFat = log10(out$PFat)
out$logFat = log10(out$Fat)
```

All fatalities
```{r}
Fat.df <-  out %>%
  filter(Fat > 0) %>%
  mutate(logFat = log10(Fat))

A <- tm_shape(states, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(Fat.df) + 
  tm_fill("logFat",
          breaks = c(0, .5, 1, 1.5, 2, 2.25),
          labels = c("1 to 16", "16 to 27", "27 to 45", "45 to 74", "> 74"),
          palette = "Reds", title = "") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE, title = "A")
```

Killer Tornadoes
```{r}
ct = st_intersection(out, KillerTorn.sf)

x <- data.frame(ct) %>%
  group_by(ID2) %>%
  summarize(nT = n())

GridRates <- merge(out, x, by = c("ID2"))

B <- tm_shape(states, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(GridRates) + 
  tm_fill("nT",
          breaks = c(0, 2, 4, 6, 8, 10),
          labels = c("0 to 2", "2 to 4", "4 to 6", "6 to 8", "> 8"),
          palette = "Reds", title = "") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE, title = "B")
```


Mobile Home Fatalities 
```{r}
out <- out %>%
  filter(MHFat > 0 | PFat > 0)

MHF.df <-  out %>%
  filter(MHFat > 0) %>%
  mutate(logMHFat = log10(MHFat))

C <- tm_shape(states, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(MHF.df) + 
  tm_fill("logMHFat",
          breaks = c(0, .5, 1, 1.25, 1.5, 2),
          labels = c("1 to 16", "16 to 27", "27 to 35", "35 to 48", "> 48"),
          palette = "Reds", title = "") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE, title = "C")
```

```{r}
PF.df <-  out %>%
  filter(PFat > 0) %>%
  mutate(logPFat = log10(PFat))

D <- tm_shape(states, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(PF.df) + 
  tm_fill("logPFat",
          breaks = c(0, .5, 1, 1.25, 1.5, 2),
          labels = c("1 to 16", "16 to 27", "27 to 35", "35 to 48", "> 48"),
          palette = "Reds", title = "") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE, title = "D")
```

```{r}
tmap_arrange(A, B, C, D)
```

Map the number of fatalities by season
```{r}
df = data.frame(KillerTorn.sf) %>%
  filter(mo == 12 | mo == 1 | mo == 2)
```

