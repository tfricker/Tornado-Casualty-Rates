---
title: "Rethinking Tornado Casualy Rates"
author: "Tyler Fricker"
date: "8/5/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

The United States experiences around 1000 tornadoes a year, resulting in nearly 1200 casualties (injuries and fatalities). While previous research has focused on analyzing and mapping the patterns of human vulnerability related to tornado casualties, little has been done to estimate the rate of tornado casualties at either the individual---per person---or household---number of houses---level.

The goal of this work is to create a baseline rate of tornado casualties given an estimate of the number of people or the number of housing units impacted by a tornado. 

Load packages.
```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(sf)
```

Begin by reading in tornado-level estimates of socioeconomic and demographic variables.
```{r}
unzip("SocialCorrelatesNew.zip")
TornSC.sf <- st_read(dsn = "SocialCorrelatesNew", 
                    layer = "SocialCorrelatesNew", 
                    stringsAsFactors = FALSE) %>%
  mutate(Date = as.Date(date),
         hr = hour(DateTim))
```

Estimate the exposure and casualty rate by year
```{r}
df <- data.frame(TornSC.sf) %>%
  group_by(Year) %>%
  summarize(nT = n(), 
         nCas = sum(cas),
         Exposure = sum(TotalPp))

ggplot(df, aes(x = Year, y = nCas)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  ylab("Casualties [Number of People]") +
  theme_minimal()

ggplot(df, aes(x = Year, y = nCas/nT)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  ylab("Casualty Rate [Number of People per Tornado]") +
  theme_minimal()

ggplot(df, aes(x = Year, y = nCas/Exposure)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  ylab("Casualty Rate [Number of People per Person]") +
  theme_minimal()

ggplot(df, aes(x = Year, y = Exposure)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  ylab("Exposure [Number of People]") +
  theme_minimal()

ggplot(df, aes(x = Year, y = Exposure/nT)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  ylab("Exposure Rate [Number of People per Tornado]") +
  theme_minimal()
```

There is not a statistically significant difference in the casualty rate per person over the last 22 years, however, the rate is decreasing over time.
```{r}
formula1 <- (nCas/Exposure) ~ Year
fit <- lm(formula1, data = df)
summary(fit)
```

Calculate the 22-year casualty rate (casualties per person) of tornadoes
```{r}
CasRate = sum(TornSC.sf$cas)/sum(TornSC.sf$TotalPp); print(CasRate)
FatRate = sum(TornSC.sf$fat)/sum(TornSC.sf$TotalPp); print(FatRate)
InjRate = sum(TornSC.sf$inj)/sum(TornSC.sf$TotalPp); print(InjRate)
```

Calculate the 22-year casualty rate (casualties per housing unit) of tornadoes
```{r}
CasRateH = sum(TornSC.sf$cas)/sum(TornSC.sf$TtlHsnU); print(CasRateH)
FatRateH = sum(TornSC.sf$fat)/sum(TornSC.sf$TtlHsnU); print(FatRateH)
InjRateH = sum(TornSC.sf$inj)/sum(TornSC.sf$TtlHsnU); print(InjRateH)
```

Calculate the ratio of injuries to fatalities
```{r}
sum(TornSC.sf$inj)/sum(TornSC.sf$fat)
```

Examples:
If a town of 100,000 people was impacted by a tornado and every person was affected, how many casualties would we expect?
```{r}
TownPop <- 100000
TownCas <- CasRate * TownPop; print(TownCas)
```

If 5,000 homes were impacted by a tornado, how many casualties would we expect?
```{r}
TownHomes <- 5000
TownCas <- CasRateH * TownHomes; print(TownCas)
```

<<<<<<< HEAD
Casualty rates by EF category
```{r}
df <- data.frame(TornSC.sf) %>%
  group_by(mag) %>%
  summarize(nT = n(),
            AvgArea = (sum(AreaPth)/n())/10^6,
            nCas = sum(cas),
            TotalPop = sum(TotalPp),
            CasRate = sum(cas)/sum(TotalPp),
            FatRate = sum(fat)/sum(TotalPp),
            InjRate = sum(inj)/sum(TotalPp),
            InjRatio = sum(inj)/sum(fat))
```

=======
## Subsets of casualty rates

Yearly casualty rates
```{r}
df <- data.frame(TornSC.sf) %>%
  group_by(Year) %>%
  summarize(nT = n(),
            CasRate = sum(cas)/sum(TotalPp),
            FatRate = sum(fat)/sum(TotalPp),
            InjRate = sum(inj)/sum(TotalPp))

ggplot(df, aes(x = Year, y = CasRate)) +
  geom_point() + geom_smooth(method = lm, color = "black", size = .35) +
  ylab("Casualty Rate [Number of People per Tornado]") +
  theme_minimal()
```

Monthly casualty rates
```{r}
df <- data.frame(TornSC.sf) %>%
  group_by(mo) %>%
  summarize(nT = n(),
            CasRate = sum(cas)/sum(TotalPp),
            FatRate = sum(fat)/sum(TotalPp),
            InjRate = sum(inj)/sum(TotalPp)) %>%
  mutate(Ma = factor(month.abb[mo], levels = month.abb[1:12]))

ggplot(df, aes(x = Ma, y = CasRate)) +
  geom_point() + geom_smooth(aes(x = mo, y = CasRate), color = "black", size = .35) +
  ylab("Casualty Rate [Number of People per Tornado]") +
  theme_minimal()
```
>>>>>>> 31821afd21fac0e1fa6e6d0b4df03ca5b0d0165f

State-level casualty rates
```{r}
df <- data.frame(TornSC.sf) %>%
  group_by(st) %>%
  summarize(nT = n(),
            CasRate = sum(cas)/sum(TotalPp),
            FatRate = sum(fat)/sum(TotalPp),
            InjRate = sum(inj)/sum(TotalPp))

df$CasRate[df$CasRate > 1] = 1

ggplot(df, aes(st)) +
  geom_col(aes(y = CasRate)) +
  xlab("State") +
  ylab("Casualty Rate [Number of People per Tornado]") +
  theme_minimal()
```

Filter by tornado-prone states (>10)
```{r}
df <- df %>%
  filter(nT > 10) %>%
  arrange(desc(CasRate))

ggplot(df, aes(st)) +
  geom_col(aes(y = CasRate)) +
  xlab("State") +
  ylab("Casualty Rate [Number of People per Tornado]") +
  theme_minimal()
```

Look at these rates spatially
```{r}
library(USAboundaries)
counties <- us_counties() %>%
  st_transform(crs = 2163) %>%
  rename(GEOID = geoid)

counties <- counties %>%
  filter(!state_abbr %in% c("AK", "PR", "HI"))
```

Find the tornadoes that intersect each county and create a county casualty rate.
```{r}
TornSC.sf <- st_transform(TornSC.sf, crs = 2163)

x = st_intersection(TornSC.sf, counties)

x <- data.frame(x[x$TotalPp > x$cas,]) %>%
  group_by(GEOID, name, state_abbr) %>%
  summarize(nT = n(),
            cas = sum(cas),
            fat = sum(fat),
            inj = sum(inj),
            TotalPop = sum(TotalPp),
            CasRate = sum(cas)/sum(TotalPp),
            FatRate = sum(fat)/sum(TotalPp),
            InjRate = sum(inj)/sum(TotalPp)) #%>%
  #filter(nT > 1)

CountyCasRates <- merge(counties, x, by = c("GEOID", "name", "state_abbr"))
```

County casualty rates
```{r}
df <- data.frame(CountyCasRates) %>%
  group_by(name, state_abbr) %>%
  summarize(nT = n(),
            CasRate = sum(cas)/sum(TotalPop),
            FatRate = sum(fat)/sum(TotalPop),
            InjRate = sum(inj)/sum(TotalPop))
```


Map county-level casualty rates
```{r}
library(tmap)
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)

tm_shape(stateBorders, projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_fill(col = "grey94") +
  tm_shape(counties) +
  tm_borders(alpha = 0.2) + 
  tm_shape(CountyCasRates) + 
  tm_fill("CasRate", palette = "Oranges", title = "Casualty Rate\n[per capita]") +
  tm_borders(alpha = 0.2) +
  tm_format('World', legend.position = c("left", "bottom"),
            attr.position = c("left", "bottom"),
            legend.frame = FALSE) +
  #tm_format_Europe(legend.position = c("left", "bottom"),
  #                 attr.position = c("left", "bottom"),
  #                 legend.frame = TRUE) +
  #tm_scale_bar(position = c("right", "bottom")) +
  #tm_compass(position = c("right", "bottom")) +
  tm_layout(frame = FALSE, attr.outside=TRUE)
```


